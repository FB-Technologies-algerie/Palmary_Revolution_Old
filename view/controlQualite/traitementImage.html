<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Palmary Revolution | Traitement d'image</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />

    <style>
      .impor {
        margin: auto;
        display: block;
        position: absolute;
        top: 50%;
        left: 42%;
      }
      .progress {
        margin: 5px;
        height: 30px;
      }
      .txt1,
      .txt2 {
        width: 100%;
        height: 300px;
      }
      del {
        text-decoration: none;
        color: #b30000;
        background: #fadad7;
      }
      ins {
        background: #eaf2c2;
        color: #406619;
        text-decoration: none;
      }
      .txtTitle {
        font-size: 30px;
        font-weight: bold;
        text-align: center;
      }
    </style>
  </head>
  <body style="width: 97vw;overflow-x:hidden;">
    <div class="row" style="margin-right: 0px;margin-left: 0px; padding: 5px 15px;">
      <div
        class="col"
        style="border-bottom:#333 solid 1px;height: fit-content;"
      >
        <p class="text-center txtTitle">
          Selectionner la première image à analyser
        </p>
        <div class="custom-file">
          <input
            type="file"
            class="custom-file-input"
            accept="image/*"
            id="validatedCustomFile"
            onchange="openFile(event,1)"
            required
          />
          <label class="custom-file-label" for="validatedCustomFile"
            >Choisir une image...</label
          >
          <div class="invalid-feedback">
            Example invalid custom file feedback
          </div>
        </div>
        <div style="width:100%;height:60vh">
          <img id="output1" style="height:auto; width:70%" hidden />
          <span>
            <div id="image-data" class="float-right" style="width: 100%">
              RGBA
              <div class="progress">
                <div
                  class="progress-bar bg-primary blue1"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-success green1"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-danger red1"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-secondary gray1"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              Noir &amp; blanc
              <div class="progress">
                <div
                  class="progress-bar bg-light white1"
                  role="progressbar"
                  style="width: 0%;color: black"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-dark black1"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>

              Luminosité
              <div class="progress">
                <div
                  class="progress-bar bg-warning orange1"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
          </span>
        </div>
      </div>
      <div
        class="col"
        style="border-bottom:#333 solid 1px;border-left:#333 solid 1px;height: fit-content;"
      >
        <p class="text-center txtTitle">
          Selectionner la deuxième image à analyser
        </p>
        <div class="custom-file">
          <input
            type="file"
            class="custom-file-input"
            accept="image/*"
            id="validatedCustomFile"
            onchange="openFile(event,2)"
            required
          />
          <label class="custom-file-label" for="validatedCustomFile"
            >Choisir une image...</label
          >
          <div class="invalid-feedback">
            Example invalid custom file feedback
          </div>
        </div>
        <div style="width:100%;height:60vh">
          <img id="output2" style="height:auto; width:70%" hidden />
          <span>
            <div id="image-data" class="float-right" style="width: 100%">
              RGBA
              <div class="progress">
                <div
                  class="progress-bar bg-primary blue2"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-success green2"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-danger red2"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-secondary gray2"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              Noir &amp; blanc
              <div class="progress">
                <div
                  class="progress-bar bg-light white2"
                  role="progressbar"
                  style="width: 0%;color: black"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress">
                <div
                  class="progress-bar bg-dark black2"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>

              Luminosité
              <div class="progress">
                <div
                  class="progress-bar bg-warning orange2"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow=""
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
          </span>
        </div>
      </div>
    </div>
    <div
      class="d-block"
      style="text-align:center;margin-top:20px;margin-bottom:20px"
    ></div>
    <div class="row">
      <div class="col">
        <div class="progress">
          <div
            class="progress-bar bg-primary loader1"
            role="progressbar"
            style="width: 0%"
            aria-valuenow=""
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
        </div>
      </div>

      <div class="col">
        <div class="progress">
          <div
            class="progress-bar bg-primary loader2"
            role="progressbar"
            style="width: 0%"
            aria-valuenow=""
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
        </div>
      </div>
    </div>

    <div hidden>
      <div class="row mt-5">
        <div class="col" style="border:#333 solid 1px">
          <p class="txtTitle">Texte de la première image</p>
          <textarea class="txt1" id="a"></textarea>
        </div>

        <div
          class="col"
          style="border-top:#333 solid 1px;border-right:#333 solid 1px;border-bottom:#333 solid 1px"
        >
          <p class="txtTitle">Texte de la deuxième image</p>
          <textarea class="txt2" id="b"></textarea>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <p class="txtTitle">Difference entre les deux textes</p>
        <div id="result"></div>
      </div>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
      integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
      integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
      crossorigin="anonymous"
    ></script>
    <script src="<?= $_SESSION['url'] ?>public/js/bower_components/resemblejs/resemble.js"></script>
    <script src="<?= $_SESSION['url'] ?>public/js/node_modules/tesseract.js/dist/tesseract.js"></script>
    <script src="<?= $_SESSION['url'] ?>public/js/node_modules/tesseract.js/dist/worker.js"></script>

    <script>
      var dataURL1;
      var dataURL2;

      function openFile(file, index) {
        console.log("index", index);

        var input = file.target;
        var reader = new FileReader();
        reader.onload = () => {
          console.log("index", index);
          if (index == "1") {
            dataURL1 = reader.result;
            var output = document.getElementById("output1");
            output.src = dataURL1;
            ressamble(dataURL1, index);
          } else {
            dataURL2 = reader.result;
            var output = document.getElementById("output2");
            output.src = dataURL2;
            ressamble(dataURL2, index);
          }
        };
        reader.readAsDataURL(input.files[0]);
      }

      function ressamble(dataURL, index) {
        resemble(dataURL).onComplete(data => {
          console.log(data);
          document.querySelector(".green" + index).style.width =
            data.green + "%";
          document.querySelector(".green" + index).textContent =
            data.green + "%";

          document.querySelector(".red" + index).style.width = data.red + "%";
          document.querySelector(".red" + index).textContent = data.red + "%";

          document.querySelector(".blue" + index).style.width = data.blue + "%";
          document.querySelector(".blue" + index).textContent = data.blue + "%";

          document.querySelector(".orange" + index).style.width =
            data.brightness + "%";
          document.querySelector(".orange" + index).textContent =
            data.brightness + "%";

          document.querySelector(".gray" + index).style.width =
            data.alpha + "%";
          document.querySelector(".gray" + index).textContent =
            data.alpha + "%";

          document.querySelector(".white" + index).style.width =
            data.white + "%";
          document.querySelector(".white" + index).textContent =
            data.white + "%";

          document.querySelector(".black" + index).style.width =
            data.black + "%";
          document.querySelector(".black" + index).textContent =
            data.black + "%";
        });
        if (dataURL1 != undefined && dataURL2 != undefined) {
          ocr();
        }
      }

      function ocr() {
        console.log("première");
        window.Tesseract1 = Tesseract.create({
          langPath:"<?= $_SESSION['url'] ?>public/js/langues/",
          corePath:"https://cdn.jsdelivr.net/gh/naptha/tesseract.js-core@0.1.0/index.js"
        })
          .recognize(dataURL1, "fra")
          .progress(function(p) {
            document.querySelector(".loader1").style.width =
              Math.round(p.progress * 100) + "%";
          })
          .finally(result => {
            console.log("deuxième");
            console.log(result);
            document.querySelector(".txt1").textContent = result.text;
            window.Tesseract2 = Tesseract.create({
              langPath: "<?= $_SESSION['url'] ?>public/js/langues/",
              corePath:
                "https://cdn.jsdelivr.net/gh/naptha/tesseract.js-core@0.1.0/index.js"
            })
              .recognize(dataURL2, "fra")
              .progress(function(p) {
                console.log("progress", p);
                document.querySelector(".loader2").style.width =
                  Math.round(p.progress * 100) + "%";
              })
              .finally(result => {
                document.querySelector(".txt2").textContent = result.text;
                check();
              });
          });
      }

      var JsDiff = (function() {
        /*jshint maxparams: 5*/
        function clonePath(path) {
          return {
            newPos: path.newPos,
            components: path.components.slice(0)
          };
       }

        function removeEmpty(array) {
          var ret = [];
          for (var i = 0; i < array.length; i++) {
            if (array[i]) {
              ret.push(array[i]);
            }
          }
          return ret;
        }

        function escapeHTML(s) {
          var n = s;
          n = n.replace(/&/g, "&amp;");
          n = n.replace(/</g, "&lt;");
          n = n.replace(/>/g, "&gt;");
          n = n.replace(/"/g, "&quot;");

          return n;
        }

        var Diff = function(ignoreWhitespace) {
          this.ignoreWhitespace = ignoreWhitespace;
        };
        Diff.prototype = {
          diff: function(oldString, newString) {
            // Handle the identity case (this is due to unrolling editLength == 0
            if (newString === oldString) {
              return [
                {
                  value: newString
                }
              ];
            }
            if (!newString) {
              return [
                {
                  value: oldString,
                  removed: true
                }
              ];
            }
            if (!oldString) {
              return [
                {
                  value: newString,
                  added: true
                }
              ];
            }

            newString = this.tokenize(newString);
            oldString = this.tokenize(oldString);

            var newLen = newString.length,
              oldLen = oldString.length;
            var maxEditLength = newLen + oldLen;
            var bestPath = [
              {
                newPos: -1,
                components: []
              }
            ];

            // Seed editLength = 0
            var oldPos = this.extractCommon(
              bestPath[0],
              newString,
              oldString,
              0
            );
            if (bestPath[0].newPos + 1 >= newLen && oldPos + 1 >= oldLen) {
              return bestPath[0].components;
            }

            for (
              var editLength = 1;
              editLength <= maxEditLength;
              editLength++
            ) {
              for (
                var diagonalPath = -1 * editLength;
                diagonalPath <= editLength;
                diagonalPath += 2
              ) {
                var basePath;
                var addPath = bestPath[diagonalPath - 1],
                  removePath = bestPath[diagonalPath + 1];
                oldPos = (removePath ? removePath.newPos : 0) - diagonalPath;
                if (addPath) {
                  // No one else is going to attempt to use this value, clear it
                  bestPath[diagonalPath - 1] = undefined;
                }

                var canAdd = addPath && addPath.newPos + 1 < newLen;
                var canRemove = removePath && 0 <= oldPos && oldPos < oldLen;
                if (!canAdd && !canRemove) {
                  bestPath[diagonalPath] = undefined;
                  continue;
                }

                // Select the diagonal that we want to branch from. We select the prior
                // path whose position in the new string is the farthest from the origin
                // and does not pass the bounds of the diff graph
                if (
                  !canAdd ||
                  (canRemove && addPath.newPos < removePath.newPos)
                ) {
                  basePath = clonePath(removePath);
                  this.pushComponent(
                    basePath.components,
                    oldString[oldPos],
                    undefined,
                    true
                  );
                } else {
                  basePath = clonePath(addPath);
                  basePath.newPos++;
                  this.pushComponent(
                    basePath.components,
                    newString[basePath.newPos],
                    true,
                    undefined
                  );
                }

                var oldPos = this.extractCommon(
                  basePath,
                  newString,
                  oldString,
                  diagonalPath
                );

                if (basePath.newPos + 1 >= newLen && oldPos + 1 >= oldLen) {
                  return basePath.components;
                } else {
                  bestPath[diagonalPath] = basePath;
                }
              }
            }
          },

          pushComponent: function(components, value, added, removed) {
            var last = components[components.length - 1];
            if (last && last.added === added && last.removed === removed) {
              // We need to clone here as the component clone operation is just
              // as shallow array clone
              components[components.length - 1] = {
                value: this.join(last.value, value),
                added: added,
                removed: removed
              };
            } else {
              components.push({
                value: value,
                added: added,
                removed: removed
              });
            }
          },
          extractCommon: function(
            basePath,
            newString,
            oldString,
            diagonalPath
          ) {
            var newLen = newString.length,
              oldLen = oldString.length,
              newPos = basePath.newPos,
              oldPos = newPos - diagonalPath;
            while (
              newPos + 1 < newLen &&
              oldPos + 1 < oldLen &&
              this.equals(newString[newPos + 1], oldString[oldPos + 1])
            ) {
              newPos++;
              oldPos++;

              this.pushComponent(
                basePath.components,
                newString[newPos],
                undefined,
                undefined
              );
            }
            basePath.newPos = newPos;
            return oldPos;
          },

          equals: function(left, right) {
            var reWhitespace = /\S/;
            if (
              this.ignoreWhitespace &&
              !reWhitespace.test(left) &&
              !reWhitespace.test(right)
            ) {
              return true;
            } else {
              return left === right;
            }
          },
          join: function(left, right) {
            return left + right;
          },
          tokenize: function(value) {
            return value;
          }
        };

        var CharDiff = new Diff();

        var WordDiff = new Diff(true);
        WordDiff.tokenize = function(value) {
          return removeEmpty(value.split(/(\s+|\b)/));
        };

        var CssDiff = new Diff(true);
        CssDiff.tokenize = function(value) {
          return removeEmpty(value.split(/([{}:;,]|\s+)/));
        };

        var LineDiff = new Diff();
        LineDiff.tokenize = function(value) {
          return value.split(/^/m);
        };

        return {
          Diff: Diff,

          diffChars: function(oldStr, newStr) {
            return CharDiff.diff(oldStr, newStr);
          },
          diffWords: function(oldStr, newStr) {
            return WordDiff.diff(oldStr, newStr);
          },
          diffLines: function(oldStr, newStr) {
            return LineDiff.diff(oldStr, newStr);
          },

          diffCss: function(oldStr, newStr) {
            return CssDiff.diff(oldStr, newStr);
          },

          createPatch: function(
            fileName,
            oldStr,
            newStr,
            oldHeader,
            newHeader
          ) {
            var ret = [];

            ret.push("Index: " + fileName);
            ret.push(
              "==================================================================="
            );
            ret.push(
              "--- " +
                fileName +
                (typeof oldHeader === "undefined" ? "" : "\t" + oldHeader)
            );
            ret.push(
              "+++ " +
                fileName +
                (typeof newHeader === "undefined" ? "" : "\t" + newHeader)
            );

            var diff = LineDiff.diff(oldStr, newStr);
            if (!diff[diff.length - 1].value) {
              diff.pop(); // Remove trailing newline add
            }
            diff.push({
              value: "",
              lines: []
            }); // Append an empty value to make cleanup easier

            function contextLines(lines) {
              return lines.map(function(entry) {
                return " " + entry;
              });
            }

            function eofNL(curRange, i, current) {
              var last = diff[diff.length - 2],
                isLast = i === diff.length - 2,
                isLastOfType =
                  i === diff.length - 3 &&
                  (current.added !== last.added ||
                    current.removed !== last.removed);

              // Figure out if this is the last line for the given file and missing NL
              if (!/\n$/.test(current.value) && (isLast || isLastOfType)) {
                curRange.push("\\ No newline at end of file");
              }
            }

            var oldRangeStart = 0,
              newRangeStart = 0,
              curRange = [],
              oldLine = 1,
              newLine = 1;
            for (var i = 0; i < diff.length; i++) {
              var current = diff[i],
                lines =
                  current.lines || current.value.replace(/\n$/, "").split("\n");
              current.lines = lines;

              if (current.added || current.removed) {
                if (!oldRangeStart) {
                  var prev = diff[i - 1];
                  oldRangeStart = oldLine;
                  newRangeStart = newLine;

                  if (prev) {
                    curRange = contextLines(prev.lines.slice(-4));
                    oldRangeStart -= curRange.length;
                    newRangeStart -= curRange.length;
                  }
                }
                curRange.push.apply(
                  curRange,
                  lines.map(function(entry) {
                    return (current.added ? "+" : "-") + entry;
                  })
                );
                eofNL(curRange, i, current);

                if (current.added) {
                  newLine += lines.length;
                } else {
                  oldLine += lines.length;
                }
              } else {
                if (oldRangeStart) {
                  // Close out any changes that have been output (or join overlapping)
                  if (lines.length <= 8 && i < diff.length - 2) {
                    // Overlapping
                    curRange.push.apply(curRange, contextLines(lines));
                  } else {
                    // end the range and output
                    var contextSize = Math.min(lines.length, 4);
                    ret.push(
                      "@@ -" +
                        oldRangeStart +
                        "," +
                        (oldLine - oldRangeStart + contextSize) +
                        " +" +
                        newRangeStart +
                        "," +
                        (newLine - newRangeStart + contextSize) +
                        " @@"
                    );
                    ret.push.apply(ret, curRange);
                    ret.push.apply(
                      ret,
                      contextLines(lines.slice(0, contextSize))
                    );
                    if (lines.length <= 4) {
                      eofNL(ret, i, current);
                    }

                    oldRangeStart = 0;
                    newRangeStart = 0;
                    curRange = [];
                  }
                }
                oldLine += lines.length;
                newLine += lines.length;
              }
            }

            return ret.join("\n") + "\n";
          },

          applyPatch: function(oldStr, uniDiff) {
            var diffstr = uniDiff.split("\n");
            var diff = [];
            var remEOFNL = false,
              addEOFNL = false;

            for (
              var i = diffstr[0][0] === "I" ? 4 : 0;
              i < diffstr.length;
              i++
            ) {
              if (diffstr[i][0] === "@") {
                var meh = diffstr[i].split(/@@ -(\d+),(\d+) \+(\d+),(\d+) @@/);
                diff.unshift({
                  start: meh[3],
                  oldlength: meh[2],
                  oldlines: [],
                  newlength: meh[4],
                  newlines: []
                });
              } else if (diffstr[i][0] === "+") {
                diff[0].newlines.push(diffstr[i].substr(1));
              } else if (diffstr[i][0] === "-") {
                diff[0].oldlines.push(diffstr[i].substr(1));
              } else if (diffstr[i][0] === " ") {
                diff[0].newlines.push(diffstr[i].substr(1));
                diff[0].oldlines.push(diffstr[i].substr(1));
              } else if (diffstr[i][0] === "\\") {
                if (diffstr[i - 1][0] === "+") {
                  remEOFNL = true;
                } else if (diffstr[i - 1][0] === "-") {
                  addEOFNL = true;
                }
              }
            }

            var str = oldStr.split("\n");
            for (var i = diff.length - 1; i >= 0; i--) {
              var d = diff[i];
              for (var j = 0; j < d.oldlength; j++) {
                if (str[d.start - 1 + j] !== d.oldlines[j]) {
                  return false;
                }
              }
              Array.prototype.splice.apply(
                str,
                [d.start - 1, +d.oldlength].concat(d.newlines)
              );
            }

            if (remEOFNL) {
              while (!str[str.length - 1]) {
                str.pop();
              }
            } else if (addEOFNL) {
              str.push("");
            }
            return str.join("\n");
          },

          convertChangesToXML: function(changes) {
            var ret = [];
            for (var i = 0; i < changes.length; i++) {
              var change = changes[i];
              if (change.added) {
                ret.push("<ins class='diff'>");
              } else if (change.removed) {
                ret.push("<del class='diff'>");
              }

              ret.push(escapeHTML(change.value));

              if (change.added) {
                ret.push("</ins>");
              } else if (change.removed) {
                ret.push("</del>");
              }
            }
            return ret.join("");
          },

          // See: http://code.google.com/p/google-diff-match-patch/wiki/API
          convertChangesToDMP: function(changes) {
            var ret = [],
              change;
            for (var i = 0; i < changes.length; i++) {
              change = changes[i];
              ret.push([
                change.added ? 1 : change.removed ? -1 : 0,
                change.value
              ]);
            }
            return ret;
          }
        };
      })();

      if (typeof module !== "undefined") {
        module.exports = JsDiff;
      }

      var a = document.getElementById("a");
      var b = document.getElementById("b");
      var result = document.getElementById("result");
      var diffType = "diffChars";

      function check() {
        var oldStr = a.value;
        var newStr = b.value;
        var changes = JsDiff[diffType](oldStr, newStr);
        console.log(changes);
        result.innerHTML = JsDiff.convertChangesToXML(changes);
      }

      a.onkeyup = b.onkeyup = a.onpaste = a.onchange = b.onpaste = b.onchange = check;
      check();

      var radio = document.getElementsByName("diff_type");
      for (var i = 0; i < radio.length; i++) {
        radio[i].onchange = function(e) {
          diffType = this.value;
          check();
        };
      }
    </script>
  </body>
</html>
